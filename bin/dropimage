#!/bin/bash

# dropimage 0.1
# Script that generates some thumbs & 
# constructs #! compatible forum code for easy image sharing

# usage:
# dropimage scrot.png
# dropimage *.png

# needed:
# dropbox, need to be run in dropbox shared folder, 
# dropbox.py, imagemagicks, xclip

# [url=linkToFullSizeImage][img]linkToThumb[/img][/url]

# vars

temp="/tmp/clip.txt"

# checks

command -v dropbox.py >/dev/null 2>&1 || { echo >&2 "I require dropbox.py but it's not on PATH, exiting."; exit 1; }
command -v convert >/dev/null 2>&1 || { echo >&2 "I require imagemagicks/convert but it's not installed, exiting."; exit 1; }
command -v xclip >/dev/null 2>&1 || { echo >&2 "I require xclip but it's not installed, exiting."; exit 1; }


[[ -f "$temp" ]] && echo "delete the $temp file" && exit

while [ $# -gt 0 ]; do

base=$(basename "${1}")
dir=$(dirname "${1}")
   
#echo "$dir/"
#echo "${base}"
#echo "$dir/${base}"


    # action
    convert "$1" -resize 160x "$dir/.${base}"
    
    # round corners http://www.imagemagick.org/Usage/thumbnails/
    convert "$dir/.${base}" \
     \( +clone  -alpha extract \
        -draw 'fill black polygon 0,0 0,5 5,0 fill white circle 5,5 5,0' \
        \( +clone -flip \) -compose Multiply -composite \
        \( +clone -flop \) -compose Multiply -composite \
     \) -alpha off -compose CopyOpacity -composite "$dir/.${base}_"
     
     mv "$dir/.${base}_" "$dir/.${base}"
     # end round corners < remove this to disable rounded corners for thumbs

    
    imageurl="$(dropbox.py puburl "$1")"
    #echo "$imageurl < imageurl"
    
    thumburl="$(dropbox.py puburl "$dir/.${base}")"
    #echo "$thumburl < thumburl"
    
    all="[url=$imageurl][img]$thumburl[/img][/url]"
    echo "$all"
    
    echo "$all" >> "$temp"


    shift

done

xclip -i -selection clipboard "$temp"
rm "$temp"

